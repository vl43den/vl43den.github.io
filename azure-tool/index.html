<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySigma Web Converter (LogPoint Edition)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f9f9f9; }
        h2 { color: #2c3e50; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #log { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; height: 350px; overflow-y: auto; font-family: "Fira Code", monospace; font-size: 14px; margin-top: 15px; }
        .success { color: #a6e22e; } 
        .error { color: #f92672; font-weight: bold; }
        .info { color: #66d9ef; }
        .warn { color: #e6db74; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
</head>
<body>

<div class="container">
    <h2>⚡ PySigma Web (LogPoint Backend)</h2>
    <p>Running the latest pySigma entirely in your browser using WebAssembly.</p>
    <div id="status">Initializing...</div>
    <div id="log"></div>
</div>

<script>
    const logElement = document.getElementById("log");
    const statusElement = document.getElementById("status");

    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.textContent = `> ${message}`;
        entry.className = type;
        logElement.appendChild(entry);
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
    }

    async function main() {
        try {
            // ---------------------------------------------------------
            // Step 1: Initialize Pyodide
            // ---------------------------------------------------------
            log("Booting Python 3.12 (WASM)...", 'info');
            let pyodide = await loadPyodide();
            log("✅ Python Environment Ready.", 'success');

            // ---------------------------------------------------------
            // Step 2: Load Micropip
            // ---------------------------------------------------------
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            log("✅ Package Installer Ready.", 'success');

            // ---------------------------------------------------------
            // Step 3: COMPLETE Dependency Injection
            // ---------------------------------------------------------
            log("Pre-loading ALL dependencies...", 'warn');
            
            // We include ALL known dependencies to prevent ModuleNotFoundErrors
            const dependencies = [
                "pyyaml",             
                "packaging",          
                "pyparsing",          
                "typing-extensions",  
                "requests",           
                "jinja2",             
                "pydantic"            
            ];
            
            await micropip.install(dependencies); 
            log("✅ Dependencies loaded.", 'success');

            // ---------------------------------------------------------
            // Step 4: Force Install pySigma
            // ---------------------------------------------------------
            log("Force-installing pySigma (Latest)...", 'warn');
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('pysigma', deps=False)
            `);
            log("✅ pySigma installed.", 'success');

            // ---------------------------------------------------------
            // Step 5: Install Custom Backend
            // ---------------------------------------------------------
            const backendFilename = "pysigma_backend_logpoint-0.3.0-py3-none-any.whl";
            
            log(`Downloading backend: ${backendFilename}...`, 'info');
            
            const check = await fetch(backendFilename);
            if (!check.ok) {
                throw new Error(`404 Not Found: ${backendFilename}.`);
            }
            
            await micropip.install(`./${backendFilename}`);
            log("✅ LogPoint Backend installed.", 'success');

            // ---------------------------------------------------------
            // Step 6: Final Verification (SMART IMPORT)
            // ---------------------------------------------------------
            log("Running system diagnostics...", 'info');
            
            await pyodide.runPythonAsync(`
                import sigma
                import yaml
                import jinja2
                
                # We try both potential class names to be safe
                backend_class = None
                try:
                    # Try Name 1: Logpoint (Seen in your error logs)
                    from sigma.backends.logpoint import Logpoint
                    backend_class = Logpoint
                    name_found = "Logpoint"
                except ImportError:
                    try:
                        # Try Name 2: LogpointBackend (Standard naming convention)
                        from sigma.backends.logpoint import LogpointBackend
                        backend_class = LogpointBackend
                        name_found = "LogpointBackend"
                    except ImportError:
                        # Debug: If both fail, print what IS inside the module
                        import sigma.backends.logpoint
                        print("DEBUG: Available names in module:", dir(sigma.backends.logpoint))
                        raise Exception("Could not find 'Logpoint' class in module.")

                print("-" * 30)
                print(f"CORE: pySigma v{sigma.__version__}")
                print(f"BACKEND: Found class '{name_found}' -> SUCCESS")
                print("-" * 30)
            `);

            statusElement.textContent = "✅ System Ready";
            statusElement.style.color = "green";

        } catch (err) {
            statusElement.textContent = "❌ System Error";
            statusElement.style.color = "red";
            log(`CRITICAL FAILURE: ${err}`, 'error');
        }
    }

    main();
</script>
</body>
</html>
