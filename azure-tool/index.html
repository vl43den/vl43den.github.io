<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySigma for LogPoint (Serverless)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
    <style>
        /* Modern, Clean UI */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; margin: 0; background: #f4f7f6; color: #333; }
        .app-container { max-width: 1000px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .status-dot { height: 12px; width: 12px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-dot.ready { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .status-dot.error { background-color: #e74c3c; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .editor-section { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: #555; }
        
        textarea { 
            width: 100%; height: 350px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; 
            font-family: "Fira Code", monospace; font-size: 13px; line-height: 1.5; resize: vertical; 
            background: #fafafa; outline: none; transition: border 0.2s;
        }
        textarea:focus { border-color: #007bff; background: white; }
        
        .controls { margin-top: 20px; text-align: right; }
        button { 
            padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 6px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; 
            opacity: 0.6; pointer-events: none; /* Disabled until loaded */
        }
        button.active { opacity: 1; pointer-events: auto; }
        button:hover { background: #0056b3; }

        #log { 
            margin-top: 30px; background: #2d2d2d; color: #f8f8f2; padding: 15px; 
            border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; 
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-success { color: #a6e22e; }
        .log-error { color: #f92672; }
        .log-info { color: #66d9ef; }
    </style>
</head>
<body>

<div class="app-container">
    <h2>
        <span id="statusDot" class="status-dot"></span> 
        <span id="headerText">Initializing System...</span>
    </h2>

    <div class="grid">
        <div class="editor-section">
            <label>Sigma Rule (YAML)</label>
            <textarea id="sigmaInput" spellcheck="false">
title: Suspicious PowerShell Download
id: 5f1f759e-d9d3-4d6a-91ef-c22222222222
status: test
description: Detects suspicious PowerShell download commands
author: Your Name
date: 2024/01/01
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\powershell.exe'
        CommandLine|contains: 'Net.WebClient'
    condition: selection
level: high
            </textarea>
        </div>

        <div class="editor-section">
            <label>LogPoint Query Output</label>
            <textarea id="queryOutput" readonly placeholder="Waiting for system to load..."></textarea>
        </div>
    </div>

    <div class="controls">
        <button id="convertBtn" onclick="runConversion()">Convert to LogPoint ðŸš€</button>
    </div>

    <div id="log"></div>
</div>

<script>
    let pyodide = null;
    const logEl = document.getElementById("log");
    const btn = document.getElementById("convertBtn");
    const dot = document.getElementById("statusDot");
    const header = document.getElementById("headerText");

    function log(msg, type='info') {
        const div = document.createElement("div");
        div.className = `log-entry log-${type}`;
        div.textContent = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function initSystem() {
        try {
            // 1. Load Pyodide
            log("Booting Python Engine (WASM)...");
            pyodide = await loadPyodide();
            
            // 2. Load Micropip
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            
            // 3. Install Dependencies (The "Kitchen Sink" List)
            log("Installing Core Dependencies...", "warn");
            const deps = ["pyyaml", "packaging", "pyparsing", "typing-extensions", "requests", "jinja2", "pydantic"];
            await micropip.install(deps);
            
            // 4. Install pySigma (Force)
            log("Installing pySigma...", "warn");
            await pyodide.runPythonAsync(`import micropip; await micropip.install('pysigma', deps=False)`);

            // 5. Install LogPoint Backend
            const wheelName = "pysigma_backend_logpoint-0.3.0-py3-none-any.whl";
            log(`Loading Plugin: ${wheelName}...`);
            
            const check = await fetch(wheelName);
            if (!check.ok) throw new Error(`Cannot find ${wheelName} (404)`);
            
            await micropip.install(`./${wheelName}`);
            
            // 6. Final Quick Check (Simplified to prevent "Stuck" state)
            log("Verifying...", "info");
            await pyodide.runPythonAsync(`
                import sigma
                import yaml
                # We simply try to import the module. If this fails, the catch block handles it.
                from sigma.backends.logpoint import Logpoint
            `);

            // SUCCESS STATE
            log("âœ… SYSTEM READY", "success");
            dot.classList.add("ready");
            header.textContent = "PySigma Converter (Ready)";
            btn.classList.add("active");
            document.getElementById("queryOutput").placeholder = "System ready. Click Convert.";

        } catch (e) {
            log(`CRITICAL ERROR: ${e.message}`, "error");
            dot.classList.add("error");
            header.textContent = "System Failed";
        }
    }

    async function runConversion() {
        if (!pyodide) return;
        
        const inputRule = document.getElementById("sigmaInput").value;
        const outputBox = document.getElementById("queryOutput");
        
        outputBox.value = "Converting...";
        log("Converting...", "info");

        try {
            // Pass the input string securely to Python
            pyodide.globals.set("user_rule", inputRule);

            // Run the Conversion Script
            // Note: We use the class name 'Logpoint' which we verified exists.
            const result = await pyodide.runPythonAsync(`
                from sigma.collection import SigmaCollection
                from sigma.backends.logpoint import Logpoint
                
                try:
                    # 1. Parse YAML
                    collection = SigmaCollection.from_yaml(user_rule)
                    
                    # 2. Initialize Backend
                    backend = Logpoint()
                    
                    # 3. Convert
                    queries = backend.convert(collection)
                    
                    # 4. Return Result (Join if multiple queries)
                    "\\n".join(queries)
                    
                except Exception as e:
                    f"ERROR: {str(e)}"
            `);

            outputBox.value = result;
            log("Conversion Complete", "success");

        } catch (err) {
            outputBox.value = `Python Error:\n${err}`;
            log("Conversion Failed", "error");
        }
    }

    // Start Boot Sequence
    initSystem();
</script>

</body>
</html>
