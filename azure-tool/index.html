<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySigma Web Converter (LogPoint Edition)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f9f9f9; }
        h2 { color: #2c3e50; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #log { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; height: 350px; overflow-y: auto; font-family: "Fira Code", monospace; font-size: 14px; margin-top: 15px; }
        .success { color: #a6e22e; } 
        .error { color: #f92672; font-weight: bold; }
        .info { color: #66d9ef; }
        .warn { color: #e6db74; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
</head>
<body>

<div class="container">
    <h2>⚡ PySigma Web (LogPoint Backend)</h2>
    <p>Running the latest pySigma entirely in your browser using WebAssembly.</p>
    <div id="status">Initializing...</div>
    <div id="log"></div>
</div>

<script>
    const logElement = document.getElementById("log");
    const statusElement = document.getElementById("status");

    // Helper to print colored logs
    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.textContent = `> ${message}`;
        entry.className = type;
        logElement.appendChild(entry);
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
    }

    async function main() {
        try {
            // ---------------------------------------------------------
            // Step 1: Initialize Pyodide
            // ---------------------------------------------------------
            log("Booting Python 3.12 (WASM)...", 'info');
            let pyodide = await loadPyodide();
            log("✅ Python Environment Ready.", 'success');

            // ---------------------------------------------------------
            // Step 2: Load Micropip (The Package Installer)
            // ---------------------------------------------------------
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            log("✅ Package Installer Ready.", 'success');

            // ---------------------------------------------------------
            // Step 3: Dependency Override (The "Fix")
            // ---------------------------------------------------------
            // The latest pySigma wants PyYAML >= 6.0.3, which crashes Pyodide.
            // We install the versions Pyodide actually HAS (e.g., 6.0.1) first.
            log("Pre-loading WebAssembly-compatible dependencies...", 'warn');
            await micropip.install(["pyyaml", "packaging"]);
            log("✅ Dependencies loaded (System Default).", 'success');

            // ---------------------------------------------------------
            // Step 4: Force Install pySigma (Latest)
            // ---------------------------------------------------------
            // We use 'deps=False' in Python to ignore the version conflict.
            log("Force-installing pySigma (Latest)...", 'warn');
            await pyodide.runPythonAsync(`
                import micropip
                # deps=False tells micropip: "Don't check versions, just install it."
                await micropip.install('pysigma', deps=False)
            `);
            log("✅ pySigma installed (Version Constraints Bypassed).", 'success');

            // ---------------------------------------------------------
            // Step 5: Install Custom Backend
            // ---------------------------------------------------------
            // CRITICAL: This filename must match the name you set on GitHub.
            const backendFilename = "pysigma_backend_logpoint-0.3.0-py3-none-any.whl";
            
            log(`Downloading backend: ${backendFilename}...`, 'info');
            
            // Safety check: verify file exists before passing to Python
            const check = await fetch(backendFilename);
            if (!check.ok) {
                throw new Error(`404 Not Found: ${backendFilename}. \nDid you rename the file on GitHub?`);
            }
            
            await micropip.install(`./${backendFilename}`);
            log("✅ LogPoint Backend installed.", 'success');

            // ---------------------------------------------------------
            // Step 6: Final Verification
            // ---------------------------------------------------------
            log("Running system diagnostics...", 'info');
            
            // We verify by importing everything.
            // Note: The python import name usually uses underscores.
            await pyodide.runPythonAsync(`
                import sigma
                import pysigma_backend_logpoint 
                import yaml
                
                print("-" * 30)
                print(f"CORE: pySigma v{sigma.__version__}")
                print(f"BACKEND: LogPoint Plugin Loaded Successfully")
                print(f"DEPS: PyYAML v{yaml.__version__} (Web Optimized)")
                print("-" * 30)
            `);

            statusElement.textContent = "✅ System Ready";
            statusElement.style.color = "green";

        } catch (err) {
            statusElement.textContent = "❌ System Error";
            statusElement.style.color = "red";
            log(`CRITICAL FAILURE: ${err}`, 'error');
            
            if (err.message.includes("404")) {
                 log("TIP: Go to GitHub and rename 'custom_backend.whl' to 'pysigma_backend_logpoint-0.3.0-py3-none-any.whl'", 'warn');
            }
        }
    }

    main();
</script>
</body>
</html>
