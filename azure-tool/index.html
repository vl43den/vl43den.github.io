<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PySigma Web Converter (LogPoint Edition)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f9f9f9; }
        h2 { color: #2c3e50; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #log { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; height: 350px; overflow-y: auto; font-family: "Fira Code", monospace; font-size: 14px; margin-top: 15px; }
        .success { color: #a6e22e; } 
        .error { color: #f92672; font-weight: bold; }
        .info { color: #66d9ef; }
        .warn { color: #e6db74; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
</head>
<body>

<div class="container">
    <h2>⚡ PySigma Web (LogPoint Backend)</h2>
    <p>Running the latest pySigma entirely in your browser using WebAssembly.</p>
    <div id="status">Initializing...</div>
    <div id="log"></div>
</div>

<script>
    const logElement = document.getElementById("log");
    const statusElement = document.getElementById("status");

    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.textContent = `> ${message}`;
        entry.className = type;
        logElement.appendChild(entry);
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
    }

    async function main() {
        try {
            // ---------------------------------------------------------
            // Step 1: Initialize Pyodide
            // ---------------------------------------------------------
            log("Booting Python 3.12 (WASM)...", 'info');
            let pyodide = await loadPyodide();
            log("✅ Python Environment Ready.", 'success');

            // ---------------------------------------------------------
            // Step 2: Load Micropip
            // ---------------------------------------------------------
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            log("✅ Package Installer Ready.", 'success');

            // ---------------------------------------------------------
            // Step 3: Manual Dependency Injection (The "Kitchen Sink" Fix)
            // ---------------------------------------------------------
            // Since we turned off auto-install, we must list EVERY library pySigma needs.
            // Added: typing-extensions, requests, colorama (just in case)
            log("Pre-loading ALL known dependencies...", 'warn');
            
            const dependencies = [
                "pyyaml", 
                "packaging", 
                "pyparsing", 
                "typing-extensions", 
                "requests"
            ];
            
            await micropip.install(dependencies); 
            log("✅ Dependencies loaded: " + dependencies.join(", "), 'success');

            // ---------------------------------------------------------
            // Step 4: Force Install pySigma (Latest)
            // ---------------------------------------------------------
            log("Force-installing pySigma (Latest)...", 'warn');
            await pyodide.runPythonAsync(`
                import micropip
                # deps=False stops it from complaining about versions, 
                # but forces us to do Step 3 manually.
                await micropip.install('pysigma', deps=False)
            `);
            log("✅ pySigma installed.", 'success');

            // ---------------------------------------------------------
            // Step 5: Install Custom Backend
            // ---------------------------------------------------------
            const backendFilename = "pysigma_backend_logpoint-0.3.0-py3-none-any.whl";
            
            log(`Downloading backend: ${backendFilename}...`, 'info');
            
            // Safety check
            const check = await fetch(backendFilename);
            if (!check.ok) {
                throw new Error(`404 Not Found: ${backendFilename}.`);
            }
            
            await micropip.install(`./${backendFilename}`);
            log("✅ LogPoint Backend installed.", 'success');

            // ---------------------------------------------------------
            // Step 6: Final Verification
            // ---------------------------------------------------------
            log("Running system diagnostics...", 'info');
            
            await pyodide.runPythonAsync(`
                import sigma
                import yaml
                import pyparsing
                import typing_extensions
                
                try:
                    from sigma.backends.logpoint import LogPointBackend
                    status_msg = "INSTALLED & LOADED"
                except ImportError as e:
                    status_msg = f"IMPORT ERROR: {str(e)}"
                    raise e

                print("-" * 30)
                print(f"CORE: pySigma v{sigma.__version__}")
                print(f"BACKEND: {status_msg}")
                print(f"DEPS: Typing Extensions v{typing_extensions.__version__}")
                print("-" * 30)
            `);

            statusElement.textContent = "✅ System Ready";
            statusElement.style.color = "green";

        } catch (err) {
            statusElement.textContent = "❌ System Error";
            statusElement.style.color = "red";
            log(`CRITICAL FAILURE: ${err}`, 'error');
        }
    }

    main();
</script>
</body>
</html>
