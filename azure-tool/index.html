<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure LogPoint Converter</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #f9f9f9; }
        textarea { width: 100%; font-family: "Consolas", "Monaco", monospace; border: 1px solid #ccc; border-radius: 4px; padding: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #e9ecef; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>üöÄ Custom Azure to LogPoint Converter</h2>
    
    <div id="status" class="status">‚è≥ Initializing Python environment...</div>

    <textarea id="yamlInput" rows="12" placeholder="Paste your Sigma Rule (YAML) here..."></textarea>
    <br><br>
    <button onclick="runConversion()" id="convertBtn" disabled>Convert Rule</button>

    <h3>LogPoint Query Output:</h3>
    <pre id="output"> Waiting for input...</pre>

    <script>
        let pyodide;

        async function main() {
            try {
                pyodide = await loadPyodide();
                
                // --- FIX STARTS HERE ---
                // We must load the package manager first!
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                // --- FIX ENDS HERE ---

                // 1. Install generic pySigma dependencies
                await micropip.install("pysigma");
                
                // 2. Install YOUR custom wheel
                // This looks for the file relative to where index.html is located
                await micropip.install("./custom_backend.whl");

                document.getElementById("status").innerHTML = "‚úÖ <b>Ready!</b> System loaded.";
                document.getElementById("status").style.background = "#d4edda";
                document.getElementById("convertBtn").disabled = false;
            } catch (err) {
                document.getElementById("status").innerHTML = "‚ùå <b>Error loading:</b> " + err;
                document.getElementById("status").style.background = "#f8d7da";
                console.error(err);
            }
        }
        main();

        async function runConversion() {
            const yaml = document.getElementById("yamlInput").value;
            // Escape backslashes and single quotes to prevent Python syntax errors
            const escapedYaml = yaml.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            
            document.getElementById("output").innerText = "Processing...";

            const pythonCode = `
from sigma.collection import SigmaCollection
from sigma.exceptions import SigmaError
from sigma.backends.logpoint import LogPointBackend

try:
    # We use triple quotes to safely wrap multi-line input
    rules = SigmaCollection.from_yaml(r'''${escapedYaml}''')
    
    backend = LogPointBackend()
    queries = backend.convert(rules)
    result = "\\n\\n".join(queries)
except SigmaError as e:
    result = f"Sigma Error: {str(e)}"
except Exception as e:
    import traceback
    result = f"Python Error: {str(e)}\\n{traceback.format_exc()}"
result
            `;
            
            try {
                const result = await pyodide.runPythonAsync(pythonCode);
                document.getElementById("output").innerText = result;
            } catch(e) {
                document.getElementById("
