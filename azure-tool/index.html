<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure LogPoint Converter (Debug Mode)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #f9f9f9; }
        textarea { width: 100%; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 15px; margin-bottom: 10px; border-radius: 4px; background: #e9ecef; border: 1px solid #ddd; font-family: monospace; font-size: 0.9em; }
        .log-entry { margin: 3px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .error { color: #dc3545; font-weight: bold; background: #fff0f0; padding: 2px; }
        .success { color: #28a745; font-weight: bold; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>üöÄ Custom Azure to LogPoint Converter</h2>
    
    <div id="status" class="status">
        <div class="log-entry">‚è≥ Starting system...</div>
    </div>

    <textarea id="yamlInput" rows="12" placeholder="Paste your Sigma Rule (YAML) here..."></textarea>
    <br><br>
    <button onclick="runConversion()" id="convertBtn" disabled>Convert Rule</button>

    <h3>Output:</h3>
    <pre id="output">Waiting for system to load...</pre>

    <script>
        // Helper to print messages to the screen
        function log(msg, type='') {
            const statusDiv = document.getElementById("status");
            const entry = document.createElement("div");
            entry.className = "log-entry " + type;
            entry.innerHTML = msg;
            statusDiv.appendChild(entry);
            console.log(msg); // Also print to browser console
        }

        let pyodide;

        async function main() {
            try {
                log("Step 1: Loading Pyodide v0.26.2...");
                pyodide = await loadPyodide();
                log("‚úÖ Pyodide loaded.", "success");

                log("Step 2: Loading Micropip package manager...");
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                log("‚úÖ Micropip ready.", "success");

                log("Step 3: Installing pySigma dependencies...");
                // This step failed before, but the new Pyodide version should fix it
                await micropip.install("pysigma");
                log("‚úÖ pySigma installed.", "success");
                
                // --- CONFIGURATION ---
                // Ensure this filename matches exactly what is in your GitHub folder!
                const wheelName = "./custom_backend.whl"; 
                // ---------------------

                log(`Step 4: Downloading custom backend: <b>${wheelName}</b>...`);
                try {
                    await micropip.install(wheelName);
                    log("‚úÖ Custom Backend installed successfully!", "success");
                } catch (wheelErr) {
                    throw new Error(`Could not load '${wheelName}'. <br>Make sure the file in your GitHub folder is named exactly 'custom_backend.whl'.<br>Details: ${wheelErr}`);
                }

                log("üöÄ <b>System Ready!</b> You can convert rules now.", "success");
                document.getElementById("status").style.background = "#d4edda";
                document.getElementById("convertBtn").disabled = false;
                document.getElementById("output").innerText = "Ready for input.";

            } catch (err) {
                log(`‚ùå <b>CRITICAL ERROR:</b><br>${err}`, "error");
                document.getElementById("status").style.background = "#f8d7da";
            }
        }
        main();

        async function runConversion() {
            const yaml = document.getElementById("yamlInput").value;
            // Escape backslashes and single quotes to prevent Python syntax errors
            const escapedYaml = yaml.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            
            document.getElementById("output").innerText = "Processing...";

            const pythonCode = `
from sigma.collection import SigmaCollection
from sigma.exceptions import SigmaError
from sigma.backends.logpoint import LogPointBackend

try:
    # We use triple quotes to safely wrap multi-line input
    rules = SigmaCollection.from_yaml(r'''${escapedYaml}''')
    
    backend = LogPointBackend()
    queries = backend.convert(rules)
    result = "\\n\\n".join(queries)
except SigmaError as e:
    result = f"Sigma Error: {str(e)}"
except Exception as e:
    import traceback
    result = f"Python Error: {str(e)}\\n{traceback.format_exc()}"
result
            `;
            
            try {
                const result = await pyodide.runPythonAsync(pythonCode);
                document.getElementById("output").innerText = result;
            } catch(e) {
                document.getElementById("output").innerText = "Runtime Error: " + e;
            }
        }
    </script>
</body>
</html>
